@model login.Models.AdminIndexViewModel
@using login.Helpers

<div class="d-flex justify-content-between align-items-center mb-3">
	<h2>Admin Panel</h2>
	<div>
		<a class="btn btn-secondary" href="/Login/Logout">Logout</a>
	</div>
</div>

<h3>Onay Bekleyen Sepetler</h3>

@if (!Model.Pending.Any())
{
	<p>Şu anda onay bekleyen sepet yok.</p>
}
else
{
	<table class="table table-hover">
		<thead>
			<tr>
				<th>Id</th>
				<th>Kullanıcı</th>
				<th>Ürünler</th>
				<th>Toplam</th>
				<th>Oluşturulma</th>
				<th>Aksiyon</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var cart in Model.Pending)
			{
				<tr id="cart-@cart.Id" data-cart-id="@cart.Id">
					<td>
						<span class="status-indicator" aria-hidden="true"></span>
						@cart.Id
					</td>
					<td>
						<div>@cart.Username</div>
						<div class="muted">@cart.Email</div>
					</td>
					<td>
						<ul class="mb-0">
							@foreach (var it in cart.Items)
							{
								<li>@it.ProductName x @it.Quantity — @TurkishLiraFormatting.Format(it.Price) (Toplam: @TurkishLiraFormatting.Format(it.LineTotal))</li>
							}
						</ul>
					</td>
					<td>@TurkishLiraFormatting.Format(cart.Total)</td>
					<td>@cart.CreatedAt.ToLocalTime().ToString("g")</td>
					<td>
						<form method="post" action="/Admin/ApproveCart">
							@Html.AntiForgeryToken()
							<input type="hidden" name="id" value="@cart.Id" />
							<button class="btn btn-success approve-button" type="submit">Onayla</button>
						</form>
					</td>
				</tr>
			}
		</tbody>
	</table>
}

<h3 class="mt-4">Onaylanmış Siparişler</h3>

@if (!Model.Confirmed.Any())
{
	<p>Henüz onaylanmış sipariş yok.</p>
}
else
{
	<table class="table table-striped">
		<thead>
			<tr>
				<th>Id</th>
				<th>Kullanıcı</th>
				<th>Ürünler</th>
				<th>Toplam</th>
				<th>Tarih</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var cart in Model.Confirmed)
			{
				<tr>
					<td>@cart.Id</td>
					<td>
						<div>@cart.Username</div>
						<div class="muted">@cart.Email</div>
					</td>
					<td>
						<ul class="mb-0">
							@foreach (var it in cart.Items)
							{
								<li>@it.ProductName x @it.Quantity — @TurkishLiraFormatting.Format(it.Price)</li>
							}
						</ul>
					</td>
					<td>@TurkishLiraFormatting.Format(cart.Total)</td>
					<td>@cart.CreatedAt.ToLocalTime().ToString("g")</td>
				</tr>
			}
		</tbody>
	</table>
}

@section Scripts {
	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.11/signalr.min.js" integrity="sha512-/qV7k6z4VQYl5D6L+3hQ7a1uQ5v0mQ0a2v9bXwYV+Vb1K6jK4n2E6ZJ4g5P3h7Cq1r8mJt9z3V8Q2YJ3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		(function(){
			const connection = new signalR.HubConnectionBuilder()
				.withUrl('/hubs/notifications')
				.withAutomaticReconnect()
				.build();

			connection.on('CartApproved', function(cartId){
				const row = document.querySelector(`#cart-${cartId}`);
				if (!row) return;
				// Add green visual indicator
				row.classList.add('approved');
				const indicator = row.querySelector('.status-indicator');
				if (indicator) {
					indicator.style.background = '#28a745';
					indicator.style.display = 'inline-block';
					indicator.style.width = '10px';
					indicator.style.height = '10px';
					indicator.style.borderRadius = '50%';
					indicator.style.marginRight = '6px';
				}
				// disable approve button and change text
				const btn = row.querySelector('.approve-button');
				if (btn) {
					btn.textContent = 'Onaylandı';
					btn.disabled = true;
					btn.classList.remove('btn-success');
					btn.classList.add('btn-secondary');
				}
			});

			connection.on('NewCartSubmitted', function(cartId){
				// show a small toast / banner on admin panel
				let banner = document.getElementById('new-cart-banner');
				if (!banner) {
					banner = document.createElement('div');
					banner.id = 'new-cart-banner';
					banner.className = 'alert alert-info';
					banner.style.position = 'fixed';
					banner.style.right = '20px';
					banner.style.bottom = '20px';
					document.body.appendChild(banner);
				}
				banner.textContent = 'Yeni sipariş geldi (ID: ' + cartId + '). Sayfayı yenileyerek görebilirsiniz.';
				setTimeout(function(){ banner.remove(); }, 8000);
			});

			connection.start().catch(err => console.error(err));
		})();
	</script>
}
